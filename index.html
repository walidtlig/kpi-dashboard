<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PENS Retouching Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
            position: relative;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .live-indicator {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #d4edda;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            color: #155724;
        }
        
        .live-dot {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .setup-section {
            background: linear-gradient(135deg, #fff9e6 0%, #ffe6e6 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
            display: none;
        }
        
        .setup-section.show {
            display: block;
        }
        
        .setup-title {
            font-size: 1.5em;
            color: #d32f2f;
            margin-bottom: 15px;
        }
        
        .config-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #555;
        }
        
        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.done { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.review { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }
        .stat-card.wip { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.avg-time { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.total { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stat-card.backlog { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        
        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .table-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .ticket-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        
        .ticket-link:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-done { background: #d4edda; color: #155724; }
        .status-review { background: #fff3cd; color: #856404; }
        .status-wip { background: #cce5ff; color: #004085; }
        .status-backlog { background: #f8d7da; color: #721c24; }
        .status-other { background: #e2e3e5; color: #383d41; }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #667eea;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }
        
        .refresh-info {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .last-update {
            display: inline-block;
            padding: 5px 10px;
            background: #e3f2fd;
            border-radius: 5px;
        }
        
        .priority-high { color: #dc3545; font-weight: bold; }
        .priority-medium { color: #ffc107; font-weight: bold; }
        .priority-low { color: #28a745; }
        
        #dashboard { display: none; }
        #dashboard.show { display: block; }
        
        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .settings-btn {
            position: absolute;
            top: 0;
            left: 0;
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="settings-btn" onclick="showSettings()" style="display: none;" id="settingsBtn">‚öôÔ∏è Settings</button>
            <div class="live-indicator" id="liveIndicator" style="display: none;">
                <div class="live-dot"></div>
                <span>Live Sync Active</span>
            </div>
            <h1>üé® PENS Retouching Live Dashboard</h1>
            <p class="subtitle">Real-time KPI Tracking & Analytics</p>
            <div class="refresh-info">
                <span id="lastUpdate" class="last-update" style="display: none;">Last updated: Never</span>
            </div>
        </div>
        
        <div class="setup-section show" id="setupSection">
            <div class="setup-title">üîó Connect to Your Google Apps Script</div>
            <p style="margin-bottom: 20px; color: #666;">
                Paste your Google Apps Script Web App URL below:
            </p>
            
            <div class="config-form">
                <div class="form-group">
                    <label>Google Apps Script URL:</label>
                    <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                    <span class="help-text">
                        Get this from your Google Apps Script deployment (Deploy ‚Üí Manage deployments ‚Üí Web app URL)
                    </span>
                </div>
                
                <button class="btn-primary" onclick="saveConfigAndConnect()">
                    üöÄ Connect & Start Dashboard
                </button>
            </div>
            
            <div id="setupError" class="error" style="display: none; margin-top: 20px;"></div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <div>Syncing with Jira...</div>
        </div>

        <div id="dashboard">
            <div class="filters">
                <div class="filter-group">
                    <label for="startDate">üìÖ Start Date:</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group">
                    <label for="endDate">üìÖ End Date:</label>
                    <input type="date" id="endDate">
                </div>
                <div class="filter-group">
                    <label for="assigneeFilter">üë§ Assignee:</label>
                    <select id="assigneeFilter">
                        <option value="">All Assignees</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">üìä Status:</label>
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn-primary" onclick="applyFilters()">Apply Filters</button>
                </div>
                <div class="filter-group">
                    <button class="btn-primary" onclick="refreshData()">üîÑ Refresh</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-label">üìã Total Tickets</div>
                    <div class="stat-number" id="totalCount">0</div>
                </div>
                <div class="stat-card done">
                    <div class="stat-label">‚úÖ Done</div>
                    <div class="stat-number" id="doneCount">0</div>
                </div>
                <div class="stat-card review">
                    <div class="stat-label">üëÅÔ∏è Review</div>
                    <div class="stat-number" id="reviewCount">0</div>
                </div>
                <div class="stat-card wip">
                    <div class="stat-label">üî® WIP</div>
                    <div class="stat-number" id="wipCount">0</div>
                </div>
                <div class="stat-card backlog">
                    <div class="stat-label">üì¶ Backlog</div>
                    <div class="stat-number" id="backlogCount">0</div>
                </div>
                <div class="stat-card avg-time">
                    <div class="stat-label">‚è±Ô∏è Avg. Time</div>
                    <div class="stat-number" id="avgTime">0h</div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-container">
                    <h3 class="chart-title">üìä Status Distribution</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">üë• Assignee Workload</h3>
                    <canvas id="assigneeChart"></canvas>
                </div>
            </div>

            <div class="chart-container" style="margin-bottom: 20px;">
                <h3 class="chart-title">üìà Completion Timeline</h3>
                <canvas id="timelineChart"></canvas>
            </div>

            <div class="table-container">
                <h3 class="chart-title">üë§ Assignee Performance</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Assignee</th>
                            <th>Total</th>
                            <th>Done</th>
                            <th>Review</th>
                            <th>WIP</th>
                            <th>Backlog</th>
                            <th>Avg. Time</th>
                        </tr>
                    </thead>
                    <tbody id="assigneeTableBody"></tbody>
                </table>
            </div>

            <div class="table-container">
                <h3 class="chart-title">üëÅÔ∏è Tickets in Review</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Summary</th>
                            <th>Assignee</th>
                            <th>Days</th>
                            <th>Priority</th>
                        </tr>
                    </thead>
                    <tbody id="reviewTableBody"></tbody>
                </table>
            </div>

            <div class="table-container">
                <h3 class="chart-title">üî® Retouching WIP</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Summary</th>
                            <th>Assignee</th>
                            <th>Days</th>
                            <th>Priority</th>
                        </tr>
                    </thead>
                    <tbody id="wipTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let config = { apiUrl: '' };
        let autoRefreshInterval = null;

        window.addEventListener('load', function() {
            loadConfig();
            if (isConfigured()) {
                startDashboard();
            }
        });

        function loadConfig() {
            const saved = localStorage.getItem('dashboardConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('apiUrl').value = config.apiUrl;
            }
        }

        function isConfigured() {
            return config.apiUrl && config.apiUrl.length > 0;
        }

        function saveConfigAndConnect() {
            config.apiUrl = document.getElementById('apiUrl').value.trim();

            if (!config.apiUrl) {
                showSetupError('Please enter your Google Apps Script URL');
                return;
            }

            localStorage.setItem('dashboardConfig', JSON.stringify(config));
            startDashboard();
        }

        function showSettings() {
            document.getElementById('setupSection').classList.add('show');
            document.getElementById('dashboard').classList.remove('show');
            stopAutoRefresh();
        }

        function startDashboard() {
            document.getElementById('setupSection').classList.remove('show');
            document.getElementById('setupError').style.display = 'none';
            document.getElementById('settingsBtn').style.display = 'block';
            fetchJiraData();
            startAutoRefresh();
        }

        function showSetupError(message) {
            const errorDiv = document.getElementById('setupError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        async function fetchJiraData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('liveIndicator').style.display = 'none';

            try {
                const response = await fetch(config.apiUrl + '?action=getIssues');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.success || !data.issues) {
                    throw new Error('Invalid response from API');
                }

                rawData = data.issues;
                processData();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').classList.add('show');
                document.getElementById('liveIndicator').style.display = 'flex';
                updateLastUpdateTime();

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                showSetupError(`Failed to fetch data: ${error.message}`);
                document.getElementById('setupSection').classList.add('show');
            }
        }

        function processData() {
            const assignees = [...new Set(rawData.map(row => row.Assignee))].sort();
            const assigneeSelect = document.getElementById('assigneeFilter');
            assigneeSelect.innerHTML = '<option value="">All Assignees</option>';
            assignees.forEach(assignee => {
                const option = document.createElement('option');
                option.value = assignee;
                option.textContent = assignee;
                assigneeSelect.appendChild(option);
            });

            const statuses = [...new Set(rawData.map(row => row.Status))].sort();
            const statusSelect = document.getElementById('statusFilter');
            statusSelect.innerHTML = '<option value="">All Statuses</option>';
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusSelect.appendChild(option);
            });

            applyFilters();
        }

        function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const assignee = document.getElementById('assigneeFilter').value;
            const status = document.getElementById('statusFilter').value;

            filteredData = rawData.filter(row => {
                if (assignee && row.Assignee !== assignee) return false;
                if (status && row.Status !== status) return false;
                if (startDate && row.Created && new Date(row.Created) < new Date(startDate)) return false;
                if (endDate && row.Created && new Date(row.Created) > new Date(endDate + 'T23:59:59')) return false;
                return true;
            });

            updateDashboard();
        }

        function updateDashboard() {
            updateStats();
            updateCharts();
            updateTables();
        }

        function updateStats() {
            const total = filteredData.length;
            const done = filteredData.filter(row => row.Status === 'Done').length;
            const review = filteredData.filter(row => row.Status === 'Review').length;
            const wip = filteredData.filter(row => row.Status === 'Retouching WIP').length;
            const backlog = filteredData.filter(row => row.Status === 'Backlog').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('doneCount').textContent = done;
            document.getElementById('reviewCount').textContent = review;
            document.getElementById('wipCount').textContent = wip;
            document.getElementById('backlogCount').textContent = backlog;

            const avgTime = calculateAverageTime();
            document.getElementById('avgTime').textContent = avgTime;
        }

        function calculateAverageTime() {
            const doneTickets = filteredData.filter(row => row.Status === 'Done' && row.Created && row.Resolved);
            if (doneTickets.length === 0) return '0h';

            let totalHours = 0;
            doneTickets.forEach(ticket => {
                const created = new Date(ticket.Created);
                const resolved = new Date(ticket.Resolved);
                const hours = (resolved - created) / (1000 * 60 * 60);
                if (hours > 0) totalHours += hours;
            });

            const avgHours = Math.round(totalHours / doneTickets.length);
            return avgHours < 24 ? avgHours + 'h' : Math.round(avgHours / 24) + 'd';
        }

        function updateCharts() {
            // Status Chart
            const statusCounts = {};
            filteredData.forEach(row => {
                statusCounts[row.Status] = (statusCounts[row.Status] || 0) + 1;
            });

            if (charts.statusChart) charts.statusChart.destroy();
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            charts.statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#38ef7d', '#ff6a00', '#f5576c', '#00f2fe', '#764ba2', '#ffc107']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Assignee Chart
            const assigneeCounts = {};
            filteredData.forEach(row => {
                assigneeCounts[row.Assignee] = (assigneeCounts[row.Assignee] || 0) + 1;
            });

            if (charts.assigneeChart) charts.assigneeChart.destroy();
            const assigneeCtx = document.getElementById('assigneeChart').getContext('2d');
            charts.assigneeChart = new Chart(assigneeCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(assigneeCounts),
                    datasets: [{
                        label: 'Tickets',
                        data: Object.values(assigneeCounts),
                        backgroundColor: '#667eea'
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });

            // Timeline Chart
            const timelineData = {};
            filteredData.forEach(row => {
                if (row.Resolved) {
                    const date = row.Resolved.split('T')[0];
                    timelineData[date] = (timelineData[date] || 0) + 1;
                }
            });

            if (charts.timelineChart) charts.timelineChart.destroy();
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            const sortedDates = Object.keys(timelineData).sort();
            charts.timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Completed',
                        data: sortedDates.map(date => timelineData[date]),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateTables() {
            // Assignee Performance
            const assigneeStats = {};
            filteredData.forEach(row => {
                const assignee = row.Assignee;
                if (!assigneeStats[assignee]) {
                    assigneeStats[assignee] = { total: 0, done: 0, review: 0, wip: 0, backlog: 0, totalTime: 0, doneCount: 0 };
                }
                assigneeStats[assignee].total++;
                if (row.Status === 'Done') {
                    assigneeStats[assignee].done++;
                    if (row.Created && row.Resolved) {
                        const hours = (new Date(row.Resolved) - new Date(row.Created)) / (1000 * 60 * 60);
                        if (hours > 0) {
                            assigneeStats[assignee].totalTime += hours;
                            assigneeStats[assignee].doneCount++;
                        }
                    }
                } else if (row.Status === 'Review') assigneeStats[assignee].review++;
                else if (row.Status === 'Retouching WIP') assigneeStats[assignee].wip++;
                else if (row.Status === 'Backlog') assigneeStats[assignee].backlog++;
            });

            const tbody = document.getElementById('assigneeTableBody');
            tbody.innerHTML = '';
            Object.keys(assigneeStats).sort().forEach(assignee => {
                const stats = assigneeStats[assignee];
                let avgTime = 'N/A';
                if (stats.doneCount > 0) {
                    const avgHours = Math.round(stats.totalTime / stats.doneCount);
                    avgTime = avgHours < 24 ? avgHours + 'h' : Math.round(avgHours / 24) + 'd';
                }
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${assignee}</strong></td>
                        <td>${stats.total}</td>
                        <td>${stats.done}</td>
                        <td>${stats.review}</td>
                        <td>${stats.wip}</td>
                        <td>${stats.backlog}</td>
                        <td>${avgTime}</td>
                    </tr>
                `;
            });

            // Review Tickets
            const reviewTickets = filteredData.filter(row => row.Status === 'Review');
            const reviewTbody = document.getElementById('reviewTableBody');
            reviewTbody.innerHTML = reviewTickets.length === 0 ? 
                '<tr><td colspan="5" style="text-align:center;color:#999;">No tickets in review</td></tr>' :
                reviewTickets.map(t => `
                    <tr>
                        <td><a href="https://vistaprint.atlassian.net/browse/${t.Key}" target="_blank" class="ticket-link">${t.Key}</a></td>
                        <td>${t.Summary.substring(0, 50)}${t.Summary.length > 50 ? '...' : ''}</td>
                        <td>${t.Assignee}</td>
                        <td>${calculateDays(t.Updated)} days</td>
                        <td class="${getPriorityClass(t.Priority)}">${t.Priority}</td>
                    </tr>
                `).join('');

            // WIP Tickets
            const wipTickets = filteredData.filter(row => row.Status === 'Retouching WIP');
            const wipTbody = document.getElementById('wipTableBody');
            wipTbody.innerHTML = wipTickets.length === 0 ?
                '<tr><td colspan="5" style="text-align:center;color:#999;">No tickets in WIP</td></tr>' :
                wipTickets.map(t => `
                    <tr>
                        <td><a href="https://vistaprint.atlassian.net/browse/${t.Key}" target="_blank" class="ticket-link">${t.Key}</a></td>
                        <td>${t.Summary.substring(0, 50)}${t.Summary.length > 50 ? '...' : ''}</td>
                        <td>${t.Assignee}</td>
                        <td>${calculateDays(t.Updated)} days</td>
                        <td class="${getPriorityClass(t.Priority)}">${t.Priority}</td>
                    </tr>
                `).join('');
        }

        function calculateDays(dateStr) {
            if (!dateStr) return 0;
            return Math.floor((new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24));
        }

        function getPriorityClass(priority) {
            if (!priority) return '';
            const p = priority.toLowerCase();
            if (p.includes('high')) return 'priority-high';
            if (p.includes('medium')) return 'priority-medium';
            if (p.includes('low')) return 'priority-low';
            return '';
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            document.getElementById('lastUpdate').style.display = 'inline-block';
        }

        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => fetchJiraData(), 5 * 60 * 1000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        }

        function refreshData() {
            fetchJiraData();
        }
    </script>
</body>
</html>